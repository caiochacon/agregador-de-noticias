{"ast":null,"code":"var _jsxFileName = \"C:\\\\aria\\\\cicc-app\\\\front-end\\\\src\\\\context\\\\WarningsContext.js\",\n    _s = $RefreshSig$();\n\nimport React from \"react\";\nimport env from 'common/enviroment';\nimport GROUPS_ENUM from 'common/enumerators/GroupsEnum';\nimport { NavigationContext } from 'context/NavigationContext';\nimport { isAdmin } from 'common/SessionUtils';\nimport sound from 'common/notification.mp3';\nimport { getVisibilityGroups } from \"common/SessionUtils\";\nimport { getUserLogin } from \"common/SessionUtils\";\nimport { getJWT } from \"common/SessionUtils\";\nimport { getUserID } from \"common/SessionUtils\";\nimport { isComandoFiscal } from \"common/SessionUtils\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport const WarningsContext = /*#__PURE__*/React.createContext();\nexport function WarningsProvider(_ref) {\n  _s();\n\n  let {\n    children\n  } = _ref;\n\n  const EventSource = require('eventsource');\n\n  const [warningsSource, setWarningsSource] = React.useState();\n  const [eventSource, setEventSource] = React.useState();\n  const [warnings, setWarnings] = React.useState([]);\n  const [latestWarning, setLatestWarning] = React.useState();\n  const [wasReloaded, setWasReloaded] = React.useState(true);\n  const {\n    setIsMap,\n    isMap,\n    clearBell\n  } = React.useContext(NavigationContext);\n  const [isNotificationSoundEnable, setIsNotificationSoundEnable] = React.useState(true);\n  const errorEvents = [null, undefined];\n  const [traffic, setTraffic] = React.useState([]);\n  const [latestEvent, setLatestEvent] = React.useState();\n  const [deadServices, setDeadServices] = React.useState([]);\n  const audios = new Audio(sound);\n\n  const getIsMap = () => {\n    return isMap;\n  };\n\n  const changeWarningBell = warningBell => {\n    warningBell['visto'] = getIsMap();\n    setLatestWarning(() => {\n      return warningBell;\n    });\n  };\n\n  const getGroups = () => {\n    //TODO GAECO\n    let groupsId = \"[\" + GROUPS_ENUM.GERAL + \"]\";\n\n    if (isAdmin()) {\n      groupsId = \"[]\"; //NAO PODE HAVER ESPAÇO APOS A VIRGULA\n    } else if (getVisibilityGroups() && getVisibilityGroups().length > 0) {\n      groupsId = \"[\" + getVisibilityGroups().join(\",\") + \"]\";\n    }\n\n    return groupsId;\n  };\n\n  const startSSE = () => {\n    //TODO: jogar isso no rules.\n    //COMANDO FISCAL COMO SÒ VÊ NOTIFICATIONS, NÃO PRECISA DESTE SSE.\n    if (!isComandoFiscal()) {\n      console.log(\"ENV\", {\n        'username': getUserLogin(),\n        'jwt_token': getJWT(),\n        'group_ids': getGroups(),\n        'user_id': getUserID()\n      });\n      let warningSource = new EventSource(\"\".concat(env.apiAddress, \"/warnings/stream\"), {\n        headers: {\n          'username': getUserLogin(),\n          'jwt_token': getJWT(),\n          'group_ids': getGroups(),\n          'user_id': getUserID()\n        }\n      });\n\n      warningSource.onmessage = event => {\n        if (errorEvents.includes(event)) {\n          console.log(\"EVENT--EMPTY1\", new Date().toLocaleTimeString(\"pt-BR\"), event);\n        } else {\n          try {\n            if (event && event.data) {\n              let warningBell = JSON.parse(event.data.replace(/'/g, '\"'));\n              changeWarningBell(warningBell);\n            }\n          } catch (e) {\n            console.log(e);\n          }\n        }\n      };\n\n      warningSource.onerror = event => {\n        console.log(\"EVENT-ONERROR\", event);\n      };\n\n      setWarningsSource(warningSource);\n      let eventSource = new EventSource(\"\".concat(env.apiAddress, \"/events/stream\"), {\n        headers: {\n          'username': getUserLogin(),\n          'jwt_token': getJWT()\n        }\n      });\n\n      eventSource.onmessage = event => {\n        if (errorEvents.includes(event)) {} else {\n          try {\n            if (event && event.data) {\n              setLatestEvent(JSON.parse(event.data.replace(/'/g, '\"')));\n            }\n          } catch (e) {\n            console.log(\"EVENTSSTREAM-ERROR\", event, e);\n          }\n        }\n      };\n\n      setEventSource(eventSource);\n    }\n  };\n\n  React.useEffect(() => {\n    changeVisto(); // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [clearBell]);\n\n  const notReceivedWarnings = formatedWarning => {\n    for (var i = 0; i < warnings.length && i < 100; i++) {\n      if (JSON.stringify(warnings[i]) === formatedWarning) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  React.useEffect(() => {\n    if (latestWarning) {\n      latestWarning['visto'] = getIsMap();\n    }\n\n    if (!isAdmin()) {\n      if (latestWarning && latestWarning['severidade'] === 4) {\n        return;\n      }\n    }\n\n    let formatedWarning = JSON.stringify(latestWarning);\n\n    if (latestWarning && notReceivedWarnings(formatedWarning)) {\n      let notifications_to_close = []; //if (document.visibilityState === 'hidden' && latestWarning) {\n\n      if (latestWarning) {\n        let options = {\n          body: \"Total de novos alertas: \".concat(warnings.filter(warning => {\n            return !warning.visto;\n          }).length + 1),\n          icon: 'https://www.vkf-renzel.com/out/pictures/generated/product/1/356_356_75/r12044336-01/general-warning-sign-10836-1.jpg?    auto=compress&cs=tinysrgb&dpr=1&w=500',\n          dir: 'ltr'\n        };\n        const notification = new Notification('Sistema CACTO', options);\n        notifications_to_close.push(notification);\n      }\n\n      if (notifications_to_close.length > 1) {\n        const firstElement = notifications_to_close.shift();\n        firstElement.close();\n      }\n\n      if (document.visibilityState === 'visible' && !getIsMap()) {//isNotificationSoundEnable && audios.play()\n      }\n\n      if (isNotificationSoundEnable) {\n        isNotificationSoundEnable && audios.play();\n      } //notification.close()\n\n\n      setWarnings([latestWarning, ...warnings]);\n    } // eslint-disable-next-line react-hooks/exhaustive-deps\n\n  }, [latestWarning]);\n  React.useEffect(() => {\n    if (latestEvent && JSON.stringify(traffic[0]) !== JSON.stringify(latestEvent)) {\n      setTraffic([latestEvent, ...traffic]);\n    } // eslint-disable-next-line react-hooks/exhaustive-deps\n\n  }, [latestEvent]); // React.useEffect(() => {\n  //   return () => {\n  //     warningsSource.close()\n  //     eventSource.close()\n  //   }\n  //   // eslint-disable-next-line react-hooks/exhaustive-deps\n  // }, [])\n\n  function changeVisto() {\n    let warningsVistos = warnings.map((warning, index) => {\n      warning.visto = true;\n      return warning;\n    });\n    setWarnings(warningsVistos);\n  }\n\n  function printIsMap() {\n    setIsMap(true);\n  }\n\n  return /*#__PURE__*/_jsxDEV(WarningsContext.Provider, {\n    value: {\n      startSSE,\n      warnings,\n      traffic,\n      setWarnings,\n      changeVisto,\n      setIsMap,\n      isMap,\n      printIsMap,\n      setWasReloaded,\n      wasReloaded,\n      setIsNotificationSoundEnable,\n      isNotificationSoundEnable,\n      warningsSource,\n      eventSource,\n      deadServices\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 241,\n    columnNumber: 5\n  }, this);\n}\n\n_s(WarningsProvider, \"yhAg193zo02G6t2u1JL0EolMMHM=\");\n\n_c = WarningsProvider;\n\nvar _c;\n\n$RefreshReg$(_c, \"WarningsProvider\");","map":{"version":3,"sources":["C:/aria/cicc-app/front-end/src/context/WarningsContext.js"],"names":["React","env","GROUPS_ENUM","NavigationContext","isAdmin","sound","getVisibilityGroups","getUserLogin","getJWT","getUserID","isComandoFiscal","WarningsContext","createContext","WarningsProvider","children","EventSource","require","warningsSource","setWarningsSource","useState","eventSource","setEventSource","warnings","setWarnings","latestWarning","setLatestWarning","wasReloaded","setWasReloaded","setIsMap","isMap","clearBell","useContext","isNotificationSoundEnable","setIsNotificationSoundEnable","errorEvents","undefined","traffic","setTraffic","latestEvent","setLatestEvent","deadServices","setDeadServices","audios","Audio","getIsMap","changeWarningBell","warningBell","getGroups","groupsId","GERAL","length","join","startSSE","console","log","warningSource","apiAddress","headers","onmessage","event","includes","Date","toLocaleTimeString","data","JSON","parse","replace","e","onerror","useEffect","changeVisto","notReceivedWarnings","formatedWarning","i","stringify","notifications_to_close","options","body","filter","warning","visto","icon","dir","notification","Notification","push","firstElement","shift","close","document","visibilityState","play","warningsVistos","map","index","printIsMap"],"mappings":";;;AAAA,OAAOA,KAAP,MAAkB,OAAlB;AAEA,OAAOC,GAAP,MAAgB,mBAAhB;AACA,OAAOC,WAAP,MAAwB,+BAAxB;AACA,SAASC,iBAAT,QAAkC,2BAAlC;AACA,SAASC,OAAT,QAAwB,qBAAxB;AAEA,OAAOC,KAAP,MAAkB,yBAAlB;AACA,SAASC,mBAAT,QAAoC,qBAApC;AACA,SAASC,YAAT,QAA6B,qBAA7B;AACA,SAASC,MAAT,QAAuB,qBAAvB;AACA,SAASC,SAAT,QAA0B,qBAA1B;AACA,SAASC,eAAT,QAAgC,qBAAhC;;AAEA,OAAO,MAAMC,eAAe,gBAAGX,KAAK,CAACY,aAAN,EAAxB;AAGP,OAAO,SAASC,gBAAT,OAAwC;AAAA;;AAAA,MAAd;AAAEC,IAAAA;AAAF,GAAc;;AAC7C,QAAMC,WAAW,GAAGC,OAAO,CAAC,aAAD,CAA3B;;AACA,QAAM,CAACC,cAAD,EAAiBC,iBAAjB,IAAsClB,KAAK,CAACmB,QAAN,EAA5C;AACA,QAAM,CAACC,WAAD,EAAcC,cAAd,IAAgCrB,KAAK,CAACmB,QAAN,EAAtC;AACA,QAAM,CAACG,QAAD,EAAWC,WAAX,IAA0BvB,KAAK,CAACmB,QAAN,CAAe,EAAf,CAAhC;AACA,QAAM,CAACK,aAAD,EAAgBC,gBAAhB,IAAoCzB,KAAK,CAACmB,QAAN,EAA1C;AACA,QAAM,CAACO,WAAD,EAAcC,cAAd,IAAgC3B,KAAK,CAACmB,QAAN,CAAe,IAAf,CAAtC;AACA,QAAM;AAAES,IAAAA,QAAF;AAAYC,IAAAA,KAAZ;AAAmBC,IAAAA;AAAnB,MAAiC9B,KAAK,CAAC+B,UAAN,CAAiB5B,iBAAjB,CAAvC;AACA,QAAM,CAAC6B,yBAAD,EAA4BC,4BAA5B,IAA4DjC,KAAK,CAACmB,QAAN,CAAe,IAAf,CAAlE;AACA,QAAMe,WAAW,GAAG,CAAC,IAAD,EAAOC,SAAP,CAApB;AACA,QAAM,CAACC,OAAD,EAAUC,UAAV,IAAwBrC,KAAK,CAACmB,QAAN,CAAe,EAAf,CAA9B;AACA,QAAM,CAACmB,WAAD,EAAcC,cAAd,IAAgCvC,KAAK,CAACmB,QAAN,EAAtC;AACA,QAAM,CAACqB,YAAD,EAAeC,eAAf,IAAkCzC,KAAK,CAACmB,QAAN,CAAe,EAAf,CAAxC;AAGA,QAAMuB,MAAM,GAAG,IAAIC,KAAJ,CAAUtC,KAAV,CAAf;;AAMA,QAAMuC,QAAQ,GAAG,MAAM;AACrB,WAAOf,KAAP;AACD,GAFD;;AAIA,QAAMgB,iBAAiB,GAAIC,WAAD,IAAiB;AAEzCA,IAAAA,WAAW,CAAC,OAAD,CAAX,GAAuBF,QAAQ,EAA/B;AAEAnB,IAAAA,gBAAgB,CAAC,MAAM;AAAC,aAAOqB,WAAP;AAAmB,KAA3B,CAAhB;AACD,GALD;;AAOA,QAAMC,SAAS,GAAG,MAAM;AAEtB;AACA,QAAIC,QAAQ,GAAG,MAAM9C,WAAW,CAAC+C,KAAlB,GAA0B,GAAzC;;AACA,QAAI7C,OAAO,EAAX,EAAe;AACb4C,MAAAA,QAAQ,GAAG,IAAX,CADa,CACG;AACjB,KAFD,MAEO,IAAI1C,mBAAmB,MAAMA,mBAAmB,GAAG4C,MAAtB,GAA+B,CAA5D,EAA+D;AACpEF,MAAAA,QAAQ,GAAG,MAAK1C,mBAAmB,GAAG6C,IAAtB,CAA2B,GAA3B,CAAL,GAAuC,GAAlD;AACD;;AACD,WAAOH,QAAP;AAED,GAXD;;AAaA,QAAMI,QAAQ,GAAG,MAAM;AAErB;AACA;AACA,QAAI,CAAC1C,eAAe,EAApB,EAAwB;AAEtB2C,MAAAA,OAAO,CAACC,GAAR,CAAY,KAAZ,EAAmB;AACjB,oBAAY/C,YAAY,EADP;AAEjB,qBAAaC,MAAM,EAFF;AAGjB,qBAAauC,SAAS,EAHL;AAIjB,mBAAWtC,SAAS;AAJH,OAAnB;AAMA,UAAI8C,aAAa,GAAG,IAAIxC,WAAJ,WAAmBd,GAAG,CAACuD,UAAvB,uBAAqD;AACvEC,QAAAA,OAAO,EAAE;AACP,sBAAYlD,YAAY,EADjB;AAEP,uBAAaC,MAAM,EAFZ;AAGP,uBAAauC,SAAS,EAHf;AAIP,qBAAWtC,SAAS;AAJb;AAD8D,OAArD,CAApB;;AAQA8C,MAAAA,aAAa,CAACG,SAAd,GAA2BC,KAAD,IAAW;AACnC,YAAIzB,WAAW,CAAC0B,QAAZ,CAAqBD,KAArB,CAAJ,EAAiC;AAC/BN,UAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ,EAA6B,IAAIO,IAAJ,GAAWC,kBAAX,CAA8B,OAA9B,CAA7B,EAAqEH,KAArE;AACD,SAFD,MAGK;AACH,cAAI;AACF,gBAAIA,KAAK,IAAIA,KAAK,CAACI,IAAnB,EAAyB;AACvB,kBAAIjB,WAAW,GAAGkB,IAAI,CAACC,KAAL,CAAWN,KAAK,CAACI,IAAN,CAAWG,OAAX,CAAmB,IAAnB,EAAyB,GAAzB,CAAX,CAAlB;AACArB,cAAAA,iBAAiB,CAACC,WAAD,CAAjB;AACD;AACF,WALD,CAKE,OAAOqB,CAAP,EAAU;AACVd,YAAAA,OAAO,CAACC,GAAR,CAAYa,CAAZ;AACD;AACF;AACF,OAdD;;AAgBAZ,MAAAA,aAAa,CAACa,OAAd,GAAyBT,KAAD,IAAW;AACjCN,QAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ,EAA6BK,KAA7B;AACD,OAFD;;AAIAzC,MAAAA,iBAAiB,CAACqC,aAAD,CAAjB;AAEA,UAAInC,WAAW,GAAG,IAAIL,WAAJ,WAAmBd,GAAG,CAACuD,UAAvB,qBAAmD;AACnEC,QAAAA,OAAO,EAAE;AACP,sBAAYlD,YAAY,EADjB;AAEP,uBAAaC,MAAM;AAFZ;AAD0D,OAAnD,CAAlB;;AAQAY,MAAAA,WAAW,CAACsC,SAAZ,GAAyBC,KAAD,IAAW;AACjC,YAAIzB,WAAW,CAAC0B,QAAZ,CAAqBD,KAArB,CAAJ,EAAiC,CAEhC,CAFD,MAGK;AACH,cAAI;AACF,gBAAIA,KAAK,IAAIA,KAAK,CAACI,IAAnB,EAAyB;AACvBxB,cAAAA,cAAc,CAACyB,IAAI,CAACC,KAAL,CAAWN,KAAK,CAACI,IAAN,CAAWG,OAAX,CAAmB,IAAnB,EAAyB,GAAzB,CAAX,CAAD,CAAd;AACD;AACF,WAJD,CAIE,OAAOC,CAAP,EAAU;AACVd,YAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ,EAAkCK,KAAlC,EAAyCQ,CAAzC;AACD;AAEF;AACF,OAdD;;AAeA9C,MAAAA,cAAc,CAACD,WAAD,CAAd;AAED;AACF,GApED;;AAsEApB,EAAAA,KAAK,CAACqE,SAAN,CAAgB,MAAM;AAEpBC,IAAAA,WAAW,GAFS,CAIpB;AACD,GALD,EAKG,CAACxC,SAAD,CALH;;AAQA,QAAMyC,mBAAmB,GAAIC,eAAD,IAAqB;AAE/C,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAiBA,CAAC,GAAGnD,QAAQ,CAAC4B,MAAb,IAAuBuB,CAAC,GAAG,GAA5C,EAAkDA,CAAC,EAAnD,EAAuD;AACrD,UAAIT,IAAI,CAACU,SAAL,CAAepD,QAAQ,CAACmD,CAAD,CAAvB,MAAgCD,eAApC,EAAqD;AACnD,eAAO,KAAP;AACD;AACF;;AACD,WAAO,IAAP;AACD,GARD;;AAWAxE,EAAAA,KAAK,CAACqE,SAAN,CAAgB,MAAM;AAEpB,QAAI7C,aAAJ,EAAmB;AACjBA,MAAAA,aAAa,CAAC,OAAD,CAAb,GAAyBoB,QAAQ,EAAjC;AACD;;AAED,QAAI,CAACxC,OAAO,EAAZ,EAAgB;AACd,UAAIoB,aAAa,IAAIA,aAAa,CAAC,YAAD,CAAb,KAAgC,CAArD,EAAwD;AACtD;AACD;AACF;;AAED,QAAIgD,eAAe,GAAGR,IAAI,CAACU,SAAL,CAAelD,aAAf,CAAtB;;AAEA,QAAIA,aAAa,IAAI+C,mBAAmB,CAACC,eAAD,CAAxC,EAA2D;AACzD,UAAIG,sBAAsB,GAAG,EAA7B,CADyD,CAIzD;;AACA,UAAInD,aAAJ,EAAmB;AAEjB,YAAIoD,OAAO,GAAG;AACZC,UAAAA,IAAI,oCAA6BvD,QAAQ,CAACwD,MAAT,CAAgBC,OAAO,IAAI;AAC1D,mBAAO,CAACA,OAAO,CAACC,KAAhB;AACD,WAFgC,EAE9B9B,MAF8B,GAErB,CAFR,CADQ;AAIZ+B,UAAAA,IAAI,EAAE,gKAJM;AAKZC,UAAAA,GAAG,EAAE;AALO,SAAd;AAQA,cAAMC,YAAY,GAAG,IAAIC,YAAJ,CAAiB,eAAjB,EAAkCR,OAAlC,CAArB;AAEAD,QAAAA,sBAAsB,CAACU,IAAvB,CAA4BF,YAA5B;AACD;;AAED,UAAIR,sBAAsB,CAACzB,MAAvB,GAAgC,CAApC,EAAuC;AACrC,cAAMoC,YAAY,GAAGX,sBAAsB,CAACY,KAAvB,EAArB;AACAD,QAAAA,YAAY,CAACE,KAAb;AACD;;AAED,UAAIC,QAAQ,CAACC,eAAT,KAA6B,SAA7B,IAA0C,CAAC9C,QAAQ,EAAvD,EAA2D,CACzD;AACD;;AAED,UAAIZ,yBAAJ,EAA+B;AAC7BA,QAAAA,yBAAyB,IAAIU,MAAM,CAACiD,IAAP,EAA7B;AACD,OA/BwD,CAiCzD;;;AAEApE,MAAAA,WAAW,CAAC,CAACC,aAAD,EAAgB,GAAGF,QAAnB,CAAD,CAAX;AAED,KAnDmB,CAqDpB;;AACD,GAtDD,EAsDG,CAACE,aAAD,CAtDH;AAwDAxB,EAAAA,KAAK,CAACqE,SAAN,CAAgB,MAAM;AACpB,QAAI/B,WAAW,IAAI0B,IAAI,CAACU,SAAL,CAAetC,OAAO,CAAC,CAAD,CAAtB,MAA+B4B,IAAI,CAACU,SAAL,CAAepC,WAAf,CAAlD,EAA+E;AAC7ED,MAAAA,UAAU,CAAC,CAACC,WAAD,EAAc,GAAGF,OAAjB,CAAD,CAAV;AACD,KAHmB,CAKpB;;AACD,GAND,EAMG,CAACE,WAAD,CANH,EA9L6C,CAsM7C;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,WAASgC,WAAT,GAAuB;AAErB,QAAIsB,cAAc,GAAGtE,QAAQ,CAACuE,GAAT,CAAa,CAACd,OAAD,EAAUe,KAAV,KAAoB;AAEpDf,MAAAA,OAAO,CAACC,KAAR,GAAgB,IAAhB;AAEA,aAAOD,OAAP;AACD,KALoB,CAArB;AAOAxD,IAAAA,WAAW,CAACqE,cAAD,CAAX;AACD;;AAED,WAASG,UAAT,GAAsB;AACpBnE,IAAAA,QAAQ,CAAC,IAAD,CAAR;AACD;;AAED,sBACE,QAAC,eAAD,CAAiB,QAAjB;AAA0B,IAAA,KAAK,EAAE;AAAEwB,MAAAA,QAAF;AAAY9B,MAAAA,QAAZ;AAAsBc,MAAAA,OAAtB;AAA+Bb,MAAAA,WAA/B;AAA4C+C,MAAAA,WAA5C;AAAyD1C,MAAAA,QAAzD;AAAmEC,MAAAA,KAAnE;AAA0EkE,MAAAA,UAA1E;AAAsFpE,MAAAA,cAAtF;AAAsGD,MAAAA,WAAtG;AAAmHO,MAAAA,4BAAnH;AAAiJD,MAAAA,yBAAjJ;AAA4Kf,MAAAA,cAA5K;AAA4LG,MAAAA,WAA5L;AAAyMoB,MAAAA;AAAzM,KAAjC;AAAA,cACG1B;AADH;AAAA;AAAA;AAAA;AAAA,UADF;AAKD;;GAnOeD,gB;;KAAAA,gB","sourcesContent":["import React from \"react\";\r\n\r\nimport env from 'common/enviroment'\r\nimport GROUPS_ENUM from 'common/enumerators/GroupsEnum'\r\nimport { NavigationContext } from 'context/NavigationContext'\r\nimport { isAdmin } from 'common/SessionUtils';\r\n\r\nimport sound from 'common/notification.mp3'\r\nimport { getVisibilityGroups } from \"common/SessionUtils\";\r\nimport { getUserLogin } from \"common/SessionUtils\";\r\nimport { getJWT } from \"common/SessionUtils\";\r\nimport { getUserID } from \"common/SessionUtils\";\r\nimport { isComandoFiscal } from \"common/SessionUtils\";\r\n\r\nexport const WarningsContext = React.createContext();\r\n\r\n\r\nexport function WarningsProvider({ children }) {\r\n  const EventSource = require('eventsource')\r\n  const [warningsSource, setWarningsSource] = React.useState()\r\n  const [eventSource, setEventSource] = React.useState()\r\n  const [warnings, setWarnings] = React.useState([])\r\n  const [latestWarning, setLatestWarning] = React.useState()\r\n  const [wasReloaded, setWasReloaded] = React.useState(true)\r\n  const { setIsMap, isMap, clearBell } = React.useContext(NavigationContext);\r\n  const [isNotificationSoundEnable, setIsNotificationSoundEnable] = React.useState(true)\r\n  const errorEvents = [null, undefined]\r\n  const [traffic, setTraffic] = React.useState([])\r\n  const [latestEvent, setLatestEvent] = React.useState()\r\n  const [deadServices, setDeadServices] = React.useState([])\r\n\r\n\r\n  const audios = new Audio(sound)\r\n\r\n\r\n\r\n\r\n\r\n  const getIsMap = () => {\r\n    return isMap\r\n  }\r\n\r\n  const changeWarningBell = (warningBell) => {\r\n\r\n    warningBell['visto'] = getIsMap()\r\n\r\n    setLatestWarning(() => {return warningBell})\r\n  }\r\n\r\n  const getGroups = () => {\r\n\r\n    //TODO GAECO\r\n    let groupsId = \"[\" + GROUPS_ENUM.GERAL + \"]\"\r\n    if (isAdmin()) {\r\n      groupsId = \"[]\" //NAO PODE HAVER ESPAÇO APOS A VIRGULA\r\n    } else if (getVisibilityGroups() && getVisibilityGroups().length > 0) {\r\n      groupsId = \"[\"+ getVisibilityGroups().join(\",\") + \"]\"\r\n    }\r\n    return groupsId;\r\n\r\n  }\r\n\r\n  const startSSE = () => {\r\n\r\n    //TODO: jogar isso no rules.\r\n    //COMANDO FISCAL COMO SÒ VÊ NOTIFICATIONS, NÃO PRECISA DESTE SSE.\r\n    if (!isComandoFiscal()) {\r\n\r\n      console.log(\"ENV\", {\r\n        'username': getUserLogin(),\r\n        'jwt_token': getJWT(),\r\n        'group_ids': getGroups(),\r\n        'user_id': getUserID()\r\n      })\r\n      let warningSource = new EventSource(`${env.apiAddress}/warnings/stream`, {\r\n        headers: {\r\n          'username': getUserLogin(),\r\n          'jwt_token': getJWT(),\r\n          'group_ids': getGroups(),\r\n          'user_id': getUserID()\r\n        }\r\n      })\r\n      warningSource.onmessage = (event) => {\r\n        if (errorEvents.includes(event)) {\r\n          console.log(\"EVENT--EMPTY1\", new Date().toLocaleTimeString(\"pt-BR\"), event)\r\n        }\r\n        else {\r\n          try {\r\n            if (event && event.data) {\r\n              let warningBell = JSON.parse(event.data.replace(/'/g, '\"'))\r\n              changeWarningBell(warningBell)\r\n            }\r\n          } catch (e) {\r\n            console.log(e)\r\n          }\r\n        }\r\n      }\r\n\r\n      warningSource.onerror = (event) => {\r\n        console.log(\"EVENT-ONERROR\", event)\r\n      }\r\n\r\n      setWarningsSource(warningSource)\r\n\r\n      let eventSource = new EventSource(`${env.apiAddress}/events/stream`, {\r\n        headers: {\r\n          'username': getUserLogin(),\r\n          'jwt_token': getJWT()\r\n        }\r\n      }\r\n      )\r\n\r\n      eventSource.onmessage = (event) => {\r\n        if (errorEvents.includes(event)) {\r\n\r\n        }\r\n        else {\r\n          try {\r\n            if (event && event.data) {\r\n              setLatestEvent(JSON.parse(event.data.replace(/'/g, '\"')))\r\n            }\r\n          } catch (e) {\r\n            console.log(\"EVENTSSTREAM-ERROR\", event, e)\r\n          }\r\n\r\n        }\r\n      }\r\n      setEventSource(eventSource)\r\n      \r\n    }\r\n  }\r\n\r\n  React.useEffect(() => {\r\n\r\n    changeVisto()\r\n\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [clearBell])\r\n\r\n\r\n  const notReceivedWarnings = (formatedWarning) => {\r\n\r\n    for (var i = 0; (i < warnings.length && i < 100); i++) {\r\n      if (JSON.stringify(warnings[i]) === formatedWarning) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n\r\n  React.useEffect(() => {\r\n\r\n    if (latestWarning) {\r\n      latestWarning['visto'] = getIsMap()\r\n    }\r\n\r\n    if (!isAdmin()) {\r\n      if (latestWarning && latestWarning['severidade'] === 4) {\r\n        return\r\n      }\r\n    }\r\n\r\n    let formatedWarning = JSON.stringify(latestWarning)\r\n\r\n    if (latestWarning && notReceivedWarnings(formatedWarning)) {\r\n      let notifications_to_close = []\r\n\r\n\r\n      //if (document.visibilityState === 'hidden' && latestWarning) {\r\n      if (latestWarning) {\r\n\r\n        let options = {\r\n          body: `Total de novos alertas: ${warnings.filter(warning => {\r\n            return !warning.visto\r\n          }).length + 1}`,\r\n          icon: 'https://www.vkf-renzel.com/out/pictures/generated/product/1/356_356_75/r12044336-01/general-warning-sign-10836-1.jpg?    auto=compress&cs=tinysrgb&dpr=1&w=500',\r\n          dir: 'ltr',\r\n        };\r\n\r\n        const notification = new Notification('Sistema CACTO', options)\r\n\r\n        notifications_to_close.push(notification)\r\n      }\r\n\r\n      if (notifications_to_close.length > 1) {\r\n        const firstElement = notifications_to_close.shift();\r\n        firstElement.close()\r\n      }\r\n\r\n      if (document.visibilityState === 'visible' && !getIsMap()) {\r\n        //isNotificationSoundEnable && audios.play()\r\n      }\r\n\r\n      if (isNotificationSoundEnable) {\r\n        isNotificationSoundEnable && audios.play()\r\n      }\r\n\r\n      //notification.close()\r\n\r\n      setWarnings([latestWarning, ...warnings])\r\n\r\n    }\r\n\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [latestWarning])\r\n\r\n  React.useEffect(() => {\r\n    if (latestEvent && JSON.stringify(traffic[0]) !== JSON.stringify(latestEvent)) {\r\n      setTraffic([latestEvent, ...traffic])\r\n    }\r\n\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [latestEvent])\r\n\r\n  // React.useEffect(() => {\r\n  //   return () => {\r\n  //     warningsSource.close()\r\n  //     eventSource.close()\r\n  //   }\r\n  //   // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  // }, [])\r\n\r\n  function changeVisto() {\r\n\r\n    let warningsVistos = warnings.map((warning, index) => {\r\n\r\n      warning.visto = true\r\n\r\n      return warning\r\n    })\r\n\r\n    setWarnings(warningsVistos)\r\n  }\r\n\r\n  function printIsMap() {\r\n    setIsMap(true)\r\n  }\r\n\r\n  return (\r\n    <WarningsContext.Provider value={{ startSSE, warnings, traffic, setWarnings, changeVisto, setIsMap, isMap, printIsMap, setWasReloaded, wasReloaded, setIsNotificationSoundEnable, isNotificationSoundEnable, warningsSource, eventSource, deadServices}}>\r\n      {children}\r\n    </WarningsContext.Provider>\r\n  );\r\n}"]},"metadata":{},"sourceType":"module"}